# 测试阶段运行指南

## 1. 测试脚本概述

测试阶段通过 `test.py` 脚本执行，该脚本会加载训练好的模型，对指定数据集进行测试，并计算评估指标。

## 2. 测试命令格式

```bash
python test.py --dataset <数据集名称> --save_path <模型保存路径> [其他参数]
```

## 3. 主要参数说明

- `--dataset`：数据集名称（必填），支持所有配置的数据集，包括新增的 `MVTec2`
- `--save_path`：模型保存路径（必填），指向训练时保存的 checkpoint 目录
- `--model_name`：模型名称，默认为 `ViT-L-14-336`
- `--img_size`：图像大小，默认为 `518`
- `--batch_size`：批量大小，默认为 `32`
- `--visualize`：是否可视化测试结果

## 4. 测试所有数据集的命令

### 4.1 测试 MVTec 数据集
```bash
python test.py --dataset MVTec --save_path ckpt/baseline
```

### 4.2 测试 VisA 数据集
```bash
python test.py --dataset VisA --save_path ckpt/baseline
```

### 4.3 测试 MPDD 数据集
```bash
python test.py --dataset MPDD --save_path ckpt/baseline
```

### 4.4 测试 BTAD 数据集
```bash
python test.py --dataset BTAD --save_path ckpt/baseline
```

### 4.5 测试 Brain 数据集
```bash
python test.py --dataset Brain --save_path ckpt/baseline
```

### 4.6 测试 Liver 数据集
```bash
python test.py --dataset Liver --save_path ckpt/baseline
```

### 4.7 测试 Retina 数据集
```bash
python test.py --dataset Retina --save_path ckpt/baseline
```

### 4.8 测试 Colon 相关数据集
```bash
# CVC-ClinicDB
python test.py --dataset Colon_clinicDB --save_path ckpt/baseline

# CVC-ColonDB
python test.py --dataset Colon_colonDB --save_path ckpt/baseline

# CVC-300
python test.py --dataset Colon_cvc300 --save_path ckpt/baseline

# Kvasir
python test.py --dataset Colon_Kvasir --save_path ckpt/baseline
```

### 4.9 测试新增的 MVTec2 数据集
```bash
python test.py --dataset MVTec2 --save_path ckpt/baseline
```

## 5. 测试结果说明

测试完成后，会在 `--save_path` 目录中生成以下文件：

- `test.log`：测试过程日志，包含详细的评估指标
- （可选）可视化结果：如果使用 `--visualize` 参数，会生成测试结果的可视化图像

### 5.1 评估指标

测试脚本会计算以下评估指标：

- **pixel AUC**：像素级异常检测的 AUC 值
- **pixel AP**：像素级异常检测的 AP 值
- **image AUC**：图像级异常检测的 AUC 值
- **image AP**：图像级异常检测的 AP 值

这些指标会按类别计算，并生成平均值。

## 6. 注意事项

1. 确保训练时使用的参数与测试时一致，特别是 `--model_name`、`--img_size` 等
2. 确保 `--save_path` 目录中存在训练生成的 checkpoint 文件
3. 测试 MVTec2 数据集时，确保该数据集已正确配置并位于 `/root/autodl-tmp/datasets/mvtec2` 目录
4. 对于大型数据集，建议使用较大的 `--batch_size` 以提高测试速度

## 7. 示例：完整测试流程

```bash
# 1. 训练模型（以 MVTec2 为例）
python train.py --dataset MVTec2 --shot 0 --save_path ckpt/mvtec2

# 2. 测试模型
python test.py --dataset MVTec2 --save_path ckpt/mvtec2 --visualize

# 3. 查看测试结果
cat ckpt/mvtec2/test.log
```